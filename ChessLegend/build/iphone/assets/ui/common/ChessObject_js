function ChessObject(){myChess.chessObj={},myChess.chessObj.gameIndex=0,myChess.chessObj.currentMove=0,myChess.chessObj.typesOfPieces=["p","p","p","p","p","p","p","p","R","N","B","Q","K","B","N","R"];var e=myChess.boardSize,s=e/9;myChess.chessObj.board=Ti.UI.createView({left:0,top:7,width:e,height:e,backgroundImage:Ti.Filesystem.resourcesDirectory+"images/chessboard.png"});var t=Ti.UI.createView({backgroundColor:"yellow",width:8*s,height:8*s,left:.5*s,top:.5*s});myChess.chessObj.board.add(t),myChess.chessObj.board.area=t,myChess.chessObj.playModeInProgress=!1,myChess.chessObj.playingSpeed=2e3,myChess.chessObj.boardPieces=new Array(2),myChess.chessObj.boardPieces[0]=new Array(16),myChess.chessObj.boardPieces[1]=new Array(16);var r=["p","p","p","p","p","p","p","p","R","N","B","Q","K","B","N","R"],a=require("ui/common/Constant");myChess.Constant=new a;var h=myChess.Constant.pieces;for(myChess.chessObj.grids=new Array(8),i=0;8>i;++i)for(myChess.chessObj.grids[i]=new Array(8),j=0;8>j;++j){var o=Ti.UI.createView({width:s+1,height:s,left:j*s,top:i*s,pleft:j*s+s/8,ptop:i*s+s/8,left1:j*s,top1:i*s,left2:j*s+3,top2:i*s+3,size1:s+1,size2:s-6,piece:null});o.backgroundImage=(i+j)%2==0?Ti.Filesystem.resourcesDirectory+"images/gridLight.png":Ti.Filesystem.resourcesDirectory+"images/gridDark.png",myChess.chessObj.grids[i][j]=o,t.add(o)}for(var c=3*s/4,y=0;2>y;y++){color=0==y?"w":"b";for(var n=0;n<r.length;n++){var m=h[y][n],b=createPiece(m.pf,m.pr,c,m.picType,m.name);myChess.chessObj.boardPieces[y][n]=new Array,myChess.chessObj.boardPieces[y][n].x=m.pf,myChess.chessObj.boardPieces[y][n].y=m.pr,myChess.chessObj.boardPieces[y][n].obj=b,myChess.chessObj.boardPieces[y][n].pieceType=r[n],myChess.chessObj.boardPieces[y][n].onboard=!0,myChess.chessObj.boardPieces[y][n].picType=0==y?"w"+r[n]:"b"+r[n],t.add(b)}}myChess.chessObj.focus=new Array(2),myChess.chessObj.focus[0]=null,myChess.chessObj.focus[1]=null;var p=Ti.UI.createButton({height:50,width:e/2,left:e/4,top:-500,backgroundColor:"white",opacity:.5,color:"black"});return p.addEventListener("click",function(){this.fireEvent("hide")}),p.addEventListener("hide",function(){this.top=-500}),p.addEventListener("show",function(){this.title="1-0"==myChess.chessObj.game.Result?"White Won   "+myChess.chessObj.game.Result:"0-1"==myChess.chessObj.game.Result?"Black Won   "+myChess.chessObj.game.Result:"Draw   "+myChess.chessObj.game.Result,this.top=e/2-25}),myChess.chessObj.board.add(p),myChess.chessObj.resultV=p,!0}function addmark(e){for(i=0;8>i;i++){var s=Ti.UI.createLabel({width:e/2,height:e,left:10,top:10,text:i});myChess.chessObj.board.add(s)}}function setPieces(e){var s=["p","p","p","p","p","p","p","p","r","n","b","q","k","b","n","r"],t=require("ui/common/Constant"),i=new t,r=i.pieces,e=board.width/9,a=new Array;a[0]=new Array,a[1]=new Array;for(var h=0;2>h;h++){color=0==h?"w":"b";for(var o=0;o<s.length;o++){var c=r[h][o],y=createPiece(c.pf,c.pr,e,c.img,c.name);myChess.chessObj.board.add(y),a[h][o]=new Array,a[h][o].x=c.pf+1,a[h][o].y=c.pr,a[h][o].obj=y,(h=0)&&(a[h][o].pieceType=s[o]),a[h][o].pieceType=s[o],a[h][o].onboard=!0}}return outputBoardPieces(a,"in"),a}function createPiece(e,s,t,i,r){var a=Ti.UI.createImageView({width:t,height:t,left:-200,top:-200,file:e,rank:s,picType:i,name:r,onboard:!0});return a}function setPieceImage(e){var s=e.picType,t=myChess.Constant.pieceImage,i=t[s],r=i.replace(/^data:image\/(png|jpg);base64,/,""),a=Ti.Utils.base64decode(r);e.obj.image=a}function processPlay(){myChess.chessObj.playModeInProgress&&(myChess.f.moveForward(),myChess.chessObj.pTimer=setTimeout(function(){processPlay()},myChess.chessObj.playingSpeed))}function resetBoard(){for(var e=0;2>e;e++)for(var s=0;16>s;s++){var t=myChess.chessObj.boardPieces[e][s].obj.file,i=myChess.chessObj.boardPieces[e][s].obj.rank;myChess.chessObj.boardPieces[e][s].x=t,myChess.chessObj.boardPieces[e][s].y=i,myChess.chessObj.boardPieces[e][s].picType=myChess.chessObj.boardPieces[e][s].obj.picType,myChess.chessObj.boardPieces[e][s].onboard=!0}myChess.chessObj.currentMove=0}function setBoard(){for(var e=0;2>e;e++)for(var s=0;16>s;s++)if(0!=myChess.chessObj.boardPieces[e][s].onboard){var t=myChess.chessObj.boardPieces[e][s].x,i=myChess.chessObj.boardPieces[e][s].y,r=myChess.chessObj.grids[i][t-1],a=myChess.chessObj.boardPieces[e][s].obj;a.left=r.pleft,a.top=r.ptop}}function translateAMove(e,s){e=e.replace("#","");var t=-1;if(otherPlayerIndex=1==s?0:1,"O-O"==e)return doCastle(!0,s),16;if("O-O-O"==e)return doCastle(!1,s),17;var i=!1,r=!1;e=e.replace("+","");var a=e.indexOf("x")>0?!0:!1;e=e.replace("x",""),e.indexOf("8=")>=0&&(i=!0,r=e.replace(/.*?8=([A-Z])/gi,"$1"),e=e.replace(/8=[A-Z]/gi,"8")),e.indexOf("1=")>=0&&(i=!0,r=e.replace(/.*?1=([A-Z])/gi,"$1"),e=e.replace(/1=[A-Z]/gi,"1"));var h=e.substr(e.length-2,2);pieceType=e.length>2?e.substr(0,1):"p";var o=!1,c=!1;if(e.length>3){var y=e.substr(1,1);o=y.match(/[a-z]/gi)?y:!1,c=y.match(/[0-9]/gi)?y:!1}if(pieceType.match(/p|K|N|Q|R|B/)||(o=pieceType,c=pieceType,pieceType="p"),a){var n=e.substr(0,1);n.match(/[a-h]/g)&&(o=n)}o&&(o=baseConverter(o,16,10)-9);for(var m=baseConverter(h.substr(0,1),16,10)-9,b=8-h.substr(1,1),p=!1,C=!1,l=3,u=0;u<myChess.chessObj.boardPieces[s].length;u++){var d=myChess.chessObj.boardPieces[s][u];if(!(o&&o!=d.x||c&&c!=d.y&&"p"!=d.pieceType||!d.onboard)){if(d.pieceType==pieceType)switch(pieceType){case"p":var j=s%2==0?-1:1;!a&&d.x==m&&Math.abs(d.y-b)<l&&(b-d.y)*j>0&&(p=d.obj,C=u,l=Math.abs(d.y-b)),!a||d.y!=b-j||d.x!=m-1&&d.x!=m+1||(p=d.obj,C=u,opIndex=s%2==0?1:0,getObjectAtPosition(m,b,opIndex)||(d=getObjectAtPosition(m,b-j,opIndex),d&&(d.onboard=!1,d.x=-1,d.y=-1)));break;case"N":var f=Math.abs(d.x-m),O=Math.abs(d.y-b);(1==f&&2==O||2==f&&1==O)&&(p=d.obj,C=u);break;case"B":var f=Math.abs(d.x-m),O=Math.abs(d.y-b);f==O&&(p=d.obj,C=u);break;case"R":var f=Math.abs(d.x-m),O=Math.abs(d.y-b);if(0==f||0==O){var v=!1;if(0==O)for(var g=Math.min(d.x+1,m);g<=Math.max(d.x-1,m);g++){var P=getObjectAtPosition(g,b,s);if(P){v=!0;break}}if(0==f)for(var g=Math.min(d.y+1,b);g<=Math.max(d.y-1,b);g++){var P=getObjectAtPosition(m,g,s);if(P){v=!0;break}}v||(p=d.obj,C=u)}break;case"Q":p=d.obj,C=u;break;case"K":p=d.obj,C=u}if(p&&"p"!=pieceType)break}}if(r){var w=myChess.chessObj.boardPieces[s][C];w&&(w.picType=0==s?"w"+r:"b"+r)}if(p){d=getObjectAtPosition(m,b,otherPlayerIndex),d&&(d.onboard=!1,d.x=-1,d.y=-1);{myChess.chessObj.boardPieces[s][C].x,myChess.chessObj.boardPieces[s][C].y}t=C,myChess.chessObj.boardPieces[s][C].x=m,myChess.chessObj.boardPieces[s][C].y=b}return t}function moveAPiece(e){if(1>e)return void Ti.UI.info("Error:new move less one");setNotation(e);var s=myChess.chessObj.piecesStatus[e][2];if(0>s||100>s&&s>17)return void Ti.UI.info("Error: "+e+"   "+s);var t=Math.floor(s/100),i=s%100;if(16==i)return focusMoves(!1),void putPieces(e);if(17==i)return focusMoves(!1),void putPieces(e);if(0!=myChess.chessObj.piecesStatus[e-1][t][i].onboard&&0!=myChess.chessObj.piecesStatus[e][t][i].onboard){focusMoves(!1);var r=myChess.chessObj.piecesStatus[e-1][t][i].x,a=myChess.chessObj.piecesStatus[e-1][t][i].y,h=myChess.chessObj.piecesStatus[e][t][i].x,o=myChess.chessObj.piecesStatus[e][t][i].y,c=myChess.chessObj.piecesStatus[e][t][i].obj;myChess.chessObj.focus[0]=myChess.chessObj.grids[a][r-1],myChess.chessObj.focus[1]=myChess.chessObj.grids[o][h-1],myChess.chessObj.focus[1]&&(c.animate({left:myChess.chessObj.focus[1].pleft,top:myChess.chessObj.focus[1].ptop,duration:500},function(){putPieces(e)}),myChess.chessObj.focus[1].piece=c,focusMoves(!0))}}function getObjectAtPosition(e,s,t){for(var i=myChess.chessObj,r=0;r<i.boardPieces[t].length;r++){var a=i.boardPieces[t][r];if(a.onboard&&a.x==e&&a.y==s)return a}return!1}function moveOnBoard(e){for(var s=myChess.chessObj.currentMove,t=myChess.chessObj.moves,i=s;e>i;i++){var r=Math.floor(i/2),a=i%2;i==e-1?translateAMoveAnimate(t[r][a],a):i==e-2?(translateAMove(t[r][a],a),setBoard()):e-2>i&&translateAMove(t[r][a],a),prefix=0==a?"white":"black"}myChess.chessObj.currentMove=e,resetNotation(),setNotation(e)}function doCastle(e,s){for(var t=0;t<myChess.chessObj.boardPieces[s].length;t++){var i=myChess.chessObj.boardPieces[s][t];"R"==i.pieceType&&8==i.x&&e&&(newPos=6,i.x=newPos),"R"!=i.pieceType||1!=i.x||e||(newPos=4,i.x=newPos),"K"==i.pieceType&&5==i.x&&(newPos=e?7:3,i.x=newPos)}}function baseConverter(e,s,t){e+="",e=e.toUpperCase();for(var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",r=0,a=0;a<=e.length;a++)r+=i.indexOf(e.charAt(a))*Math.pow(s,e.length-a-1);e="";for(var h=Math.floor(Math.log(r)/Math.log(t)),a=h;a>=0;a--){var o=Math.floor(r/Math.pow(t,a));e+=i.charAt(o),r-=o*Math.pow(t,a)}return 0==e.length&&(e=0),e}function resetNotation(){var e=myChess.chessObj.notations;for(i=0;i<e.length;i++)e[i].w&&(e[i].w.backgroundColor="white"),e[i].b&&(e[i].b.backgroundColor="white")}function setNotation(e){resetNotation();var s=myChess.chessObj.notation,t=myChess.chessObj.notations;if(e>0){var i=Math.floor((e-1)/2),r=(e-1)%2;0==r?t[i].w.backgroundColor="orange":t[i].b.backgroundColor="orange";var a=0,h=t.length-1;i>4&&(a=i-3),h>i+3&&(h=i+3),s.fireEvent("show",{index:i+6})}}function putPieces(e){if(myChess.chessObj.resultV.fireEvent("hide"),0>e&&(e=0),myChess.chessObj.currentMove=e,myChess.chessObj.piecesStatus[e]){setNotation(e);for(var s=0;2>s;s++)for(var t=0;16>t;t++){var i=myChess.chessObj.piecesStatus[e][s][t].obj;if(0!=myChess.chessObj.piecesStatus[e][s][t].onboard){var r=myChess.chessObj.piecesStatus[e][s][t].x,a=myChess.chessObj.piecesStatus[e][s][t].y,h=myChess.chessObj.grids[a][r-1];i.left=h.pleft,i.top=h.ptop,setPieceImage(myChess.chessObj.piecesStatus[e][s][t])}else i.left=-200,i.top=-200}myChess.chessObj.currentMove==myChess.chessObj.maxMoves&&myChess.chessObj.resultV.fireEvent("show"),0==e&&(focusMoves(!1),myChess.chessObj.playModeInProgress=!1),myChess.isSound&&myChess.sound.play.play()}}function movePieces(e){e-1>myChess.chessObj.currentMove&&putPieces(e-1),myChess.chessObj.currentMove=e,moveAPiece(e)}function highlightGrid(e,s){e&&(s?(e.width=e.size2,e.height=e.size2,e.left=e.left2,e.top=e.top2):(e.width=e.size1,e.height=e.size1,e.left=e.left1,e.top=e.top1))}function focusMoves(e){highlightGrid(myChess.chessObj.focus[0],e),highlightGrid(myChess.chessObj.focus[1],e),e||(myChess.chessObj.focus[0]=null,myChess.chessObj.focus[1]=null)}module.exports=ChessObject,myChess.f.resetPieces=function(){putPieces(0),myChess.reset=!1},myChess.f.moveBackward=function(){var e=myChess.chessObj.moves;e&&(newMove=myChess.chessObj.currentMove/1-1,0>newMove&&(newMove=0),putPieces(newMove),focusMoves(!1))},myChess.f.moveForward=function(){if(!(myChess.chessObj.currentMove<0)){var e=myChess.chessObj.moves;e&&(newMove=myChess.chessObj.currentMove/1+1,newMove>myChess.chessObj.maxMoves||movePieces(newMove))}},myChess.f.moveTo=function(e){var s=myChess.chessObj.moves;if(s){var t=2*s.length-(1==s[s.length-1].length?1:0);e>t||movePieces(e)}},myChess.f.play=function(){myChess.chessObj.playModeInProgress=!0,processPlay()},myChess.f.pause=function(){myChess.chessObj.playModeInProgress=!1},myChess.f.getPiecesStatus=function(){resetBoard();var e=myChess.chessObj.game.content.split("|"),s=new Array(e.length);for(i=0;i<e.length-1;i++){var t=e[i].split("^");s[i]=new Array(2),s[i][0]=t[0],s[i][1]=t[1]}i=e.length-1;var r=e[i].split("^");"---"!=r[1]?(s[i]=new Array(2),s[i][0]=r[0],s[i][1]=r[1],myChess.chessObj.maxMoves=2*s.length):(s[i]=new Array(1),s[i][0]=r[0],myChess.chessObj.maxMoves=2*s.length-1),myChess.chessObj.moves=s;var a=myChess.chessObj.maxMoves+1;for(myChess.chessObj.piecesStatus=new Array(a),i=0;a>i;i++)myChess.chessObj.piecesStatus[i]=new Array(3),myChess.chessObj.piecesStatus[i][0]=new Array(16),myChess.chessObj.piecesStatus[i][1]=new Array(16),myChess.chessObj.piecesStatus[i][2]=null;var h=0,o="["+myChess.chessObj.piecesStatus[h][2]+"]";for(type=0;2>type;type++)for(p=0;16>p;p++)myChess.chessObj.piecesStatus[h][type][p]=new Array,myChess.chessObj.piecesStatus[h][type][p].x=myChess.chessObj.boardPieces[type][p].obj.file,myChess.chessObj.piecesStatus[h][type][p].y=myChess.chessObj.boardPieces[type][p].obj.rank,myChess.chessObj.piecesStatus[h][type][p].obj=myChess.chessObj.boardPieces[type][p].obj,myChess.chessObj.piecesStatus[h][type][p].onboard=!0,myChess.chessObj.piecesStatus[h][type][p].picType=myChess.chessObj.boardPieces[type][p].obj.picType,o+=" ("+myChess.chessObj.piecesStatus[h][type][p].picType+"  "+myChess.chessObj.piecesStatus[h][type][p].x+","+myChess.chessObj.piecesStatus[h][type][p].y+") ";for(var h=1;a>h;h++){var c=Math.floor((h-1)/2),y=(h-1)%2;if(s[c][y]){var n=translateAMove(s[c][y],y),m=100*y+n;for(myChess.chessObj.piecesStatus[h][2]=m,o="["+myChess.chessObj.piecesStatus[h][2]+"]",type=0;2>type;type++)for(p=0;16>p;p++)myChess.chessObj.piecesStatus[h][type][p]=new Array,myChess.chessObj.piecesStatus[h][type][p].obj=myChess.chessObj.boardPieces[type][p].obj,myChess.chessObj.piecesStatus[h][type][p].x=myChess.chessObj.boardPieces[type][p].x,myChess.chessObj.piecesStatus[h][type][p].y=myChess.chessObj.boardPieces[type][p].y,myChess.chessObj.piecesStatus[h][type][p].onboard=myChess.chessObj.boardPieces[type][p].onboard,myChess.chessObj.piecesStatus[h][type][p].picType=myChess.chessObj.boardPieces[type][p].picType,o+=" ("+myChess.chessObj.piecesStatus[h][type][p].picType+"  "+myChess.chessObj.piecesStatus[h][type][p].x+","+myChess.chessObj.piecesStatus[h][type][p].y+") "}}},myChess.f.flipPieces=function(e){newMove=myChess.chessObj.currentMove,Ti.API.info("flip Pieces :"+newMove);for(var s=0;2>s;s++)for(var t=0;16>t;t++){var i=myChess.chessObj.piecesStatus[newMove][s][t].obj;i.setTransform(Ti.UI.create2DMatrix({rotate:e}))}},myChess.f.validPiecesStatus=function(){Ti.API.info("Validate Status");var e=new Array,s=myChess.Games[myChess.PlayerIndex].games.length;for(Ti.API.info(myChess.PlayerIndex+" : validate >>>>"+s+"  "+myChess.Players[myChess.PlayerIndex][0]),gi=0;s>gi;gi++){myChess.chessObj.gameIndex=gi,myChess.chessObj.game=myChess.Games[myChess.PlayerIndex].games[myChess.chessObj.gameIndex];var t="";if(myChess.chessObj.game.content){t=myChess.chessObj.game.content.split("|");var r=new Array(t.length);for(i=0;i<t.length-1;i++){var a=t[i].split("^");r[i]=new Array(2),r[i][0]=a[0],r[i][1]=a[1]}i=t.length-1;var h=t[i].split("^");"---"!=h[1]?(r[i]=new Array(2),r[i][0]=h[0],r[i][1]=h[1],myChess.chessObj.maxMoves=2*r.length):(r[i]=new Array(1),r[i][0]=h[0],myChess.chessObj.maxMoves=2*r.length-1),myChess.chessObj.moves=r;for(var o=0;2>o;o++)for(var c=0;16>c;c++){var y=myChess.chessObj.boardPieces[o][c].obj.file,n=myChess.chessObj.boardPieces[o][c].obj.rank;myChess.chessObj.boardPieces[o][c].x=y,myChess.chessObj.boardPieces[o][c].y=n,myChess.chessObj.boardPieces[o][c].onboard=!0,myChess.chessObj.boardPieces[o][c].picType=myChess.chessObj.boardPieces[o][c].obj.picTytpe}myChess.chessObj.currentMove=0;for(var r=myChess.chessObj.moves,m=myChess.chessObj.maxMoves+1,c=1;m>c;c++){var b=Math.floor((c-1)/2),p=(c-1)%2;if(r[b]&&r[b][p]){var C=translateAMove(r[b][p],p);if(0>C||C>17){e.push(gi);break}}}}else e.push(gi)}Ti.API.info("error:"+e)},myChess.f.getPGN=function(){var e=myChess.chessObj.game,s=myChess.chessObj.moves,t="";for(t+='[Event "'+e.Event+'"]\n',t+='[Site "'+e.Site+'"]\n',t+=e.Date?'[Date "'+e.Year+'"]\n':'[Date "'+e.Year+'.??.??"]\n',t+='[Round "'+e.Round+'"]\n',t+='[White "'+e.White+'"]\n',t+='[Black "'+e.Black+'"]\n',t+='[Result "'+e.Result+'"]\n',e.WhiteElo&&(t+='[WhiteElo "'+e.WhiteElo+'"]\n'),e.BlackElo&&(t+='[BlackElo "'+e.BlackElo+'"]\n'),e.ECO&&(t+='[ECO "'+e.ECO+'"]\n'),t+="\n \n",i=0;i<s.length;i++)t+=i+1+".",s[i][0]&&(t+=s[i][0]+" "),s[i][1]&&(t+=s[i][1]+" ");return t+=e.Result+"\n"},myChess.f.emailPGN=function(){var e=Ti.UI.createEmailDialog();e.subject=myChess.chessObj.game.White+" vs "+myChess.chessObj.game.Black+" (PNG from Chess World Champion Game Collection)",e.messageBody=myChess.f.getPGN(),e.open()},myChess.f.copyPGN=function(){Titanium.UI.Clipboard.clearText(),Titanium.UI.Clipboard.setText(myChess.f.getPGN())};