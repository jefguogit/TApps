function processPlay(){myChess.chessObj.playModeInProgress&&(myChess.f.processPlay.moveForward(),myChess.chessObj.pTimer=setTimeout(function(){processPlay()},myChess.chessObj.playingSpeed))}function resetBoard(){for(var e=0;2>e;e++)for(var s=0;16>s;s++){var t=myChess.chessObj.boardPieces[e][s].obj.file,i=myChess.chessObj.boardPieces[e][s].obj.rank;myChess.chessObj.boardPieces[e][s].x=t,myChess.chessObj.boardPieces[e][s].y=i,myChess.chessObj.boardPieces[e][s].onboard=!0}myChess.chessObj.currentMove=0,resetNotation()}function setBoard(){for(var e=0;2>e;e++)for(var s=0;16>s;s++)if(0!=myChess.chessObj.boardPieces[e][s].onboard){var t=myChess.chessObj.boardPieces[e][s].x,i=myChess.chessObj.boardPieces[e][s].y,a=myChess.chessObj.grids[i][t-1],r=myChess.chessObj.boardPieces[e][s].obj;r.left=a.pleft,r.top=a.ptop}}function translateAMove(e,s){var t=-1;if(otherPlayerIndex=1==s?0:1,"O-O"==e)return doCastle(!0,s),16;if("O-O-O"==e)return doCastle(!1,s),17;var i=!1,a=!1;e=e.replace("+","");var r=e.indexOf("x")>0?!0:!1;e=e.replace("x",""),e.indexOf("8=")>=0&&(i=!0,a=e.replace(/.*?8=([A-Z])/gi,"$1"),e=e.replace(/8=[A-Z]/gi,"8"));var o=e.substr(e.length-2,2);pieceType=e.length>2?e.substr(0,1):"p";var n=!1,h=!1;if(e.length>3){var c=e.substr(1,1);n=c.match(/[a-z]/gi)?c:!1,h=c.match(/[0-9]/gi)?c:!1}if(pieceType.match(/p|K|N|Q|R|B/)||(n=pieceType,h=pieceType,pieceType="p"),r){var b=e.substr(0,1);b.match(/[a-h]/g)&&(n=b)}n&&(n=baseConverter(n,16,10)-9);for(var f=baseConverter(o.substr(0,1),16,10)-9,d=8-o.substr(1,1),p=!1,m=!1,u=!1,w=10,l=0;l<myChess.chessObj.boardPieces[s].length;l++){var v=myChess.chessObj.boardPieces[s][l];if(!(n&&n!=v.x||h&&h!=v.y&&"p"!=v.pieceType)){if(v.pieceType==pieceType)switch(pieceType){case"p":var y=s%2==0?-1:1;!r&&v.x==f&&Math.abs(v.y-d)<w&&(p=v.obj,u=l,w=Math.abs(v.y-d)),!r||v.y!=d-y||v.x!=f-1&&v.x!=f+1||(p=v.obj,u=l);break;case"N":var g=Math.abs(v.x-f),C=Math.abs(v.y-d);(1==g&&2==C||2==g&&1==C)&&(p=v.obj,u=l);break;case"B":var g=Math.abs(v.x-f),C=Math.abs(v.y-d);g==C&&(p=v.obj,u=l);break;case"R":var g=Math.abs(v.x-f),C=Math.abs(v.y-d);if(0==g||0==C){var j=!1;if(0==C)for(var O=Math.min(v.x+1,f);O<=Math.max(v.x-1,f);O++){var P=getObjectAtPosition(O,d,s);if(P){j=!0;break}}if(0==g)for(var O=Math.min(v.y+1,d);O<=Math.max(v.y-1,d);O++){var P=getObjectAtPosition(f,O,s);if(P){j=!0;break}}j||(p=v.obj,u=l)}break;case"Q":p=v.obj,u=l;break;case"K":p=v.obj,u=l}if(p&&"p"!=pieceType)break}}if(a&&(myChess.chessObj.boardPieces[s][u].pieceType=a,alert("promote:"+a)),r&&(m=getObjectAtPosition(f,d,otherPlayerIndex),m.onboard=!1,m.x=-1,m.y=-1),p){v=getObjectAtPosition(f,d,otherPlayerIndex),v&&(v.onboard=!1);{myChess.chessObj.boardPieces[s][u].x,myChess.chessObj.boardPieces[s][u].y}t=u,myChess.chessObj.boardPieces[s][u].x=f,myChess.chessObj.boardPieces[s][u].y=d}return m.obj&&(m.onboard=!1,m.x=-1,m.y=-1),t}function moveAPiece(e){if(1>e)return void alert("new move less one");setNotation(e);var s=myChess.chessObj.piecesStatus[e][2];if(0>s||100>s&&s>17)return void alert(e+"   "+s);var t=Math.floor(s/100),i=s%100;if(16==i)return focusMoves(!1),void putPieces(e);if(17==i)return focusMoves(!1),void putPieces(e);if(0==myChess.chessObj.piecesStatus[e-1][t][i].onboard)return void alert("not on board 1");if(0==myChess.chessObj.piecesStatus[e][t][i].onboard)return void alert("not on board 2");focusMoves(!1);var a=myChess.chessObj.piecesStatus[e-1][t][i].x,r=myChess.chessObj.piecesStatus[e-1][t][i].y,o=myChess.chessObj.piecesStatus[e][t][i].x,n=myChess.chessObj.piecesStatus[e][t][i].y,h=myChess.chessObj.piecesStatus[e][t][i].obj;return myChess.chessObj.focus[0]=myChess.chessObj.grids[r][a-1],myChess.chessObj.focus[1]=myChess.chessObj.grids[n][o-1],myChess.chessObj.focus[1]?(h.animate({left:myChess.chessObj.focus[1].pleft,top:myChess.chessObj.focus[1].ptop,duration:500},function(){putPieces(e)}),myChess.chessObj.focus[1].piece=h,void focusMoves(!0)):void alert("Oh, error")}function getObjectAtPosition(e,s,t){for(var i=myChess.chessObj,a=0;a<i.boardPieces[t].length;a++){var r=i.boardPieces[t][a];if(r.onboard&&r.x==e&&r.y==s)return r}return!1}function moveOnBoard(e){for(var s=myChess.chessObj.currentMove,t=myChess.chessObj.moves,i=s;e>i;i++){var a=Math.floor(i/2),r=i%2;i==e-1?translateAMoveAnimate(t[a][r],r):i==e-2?(translateAMove(t[a][r],r),setBoard()):e-2>i&&translateAMove(t[a][r],r),prefix=0==r?"white":"black"}myChess.chessObj.currentMove=e,resetNotation(),setNotation(e)}function doCastle(e,s){for(var t=0;t<myChess.chessObj.boardPieces[s].length;t++){var i=myChess.chessObj.boardPieces[s][t];"R"==i.pieceType&&8==i.x&&e&&(newPos=6,i.x=newPos),"R"!=i.pieceType||1!=i.x||e||(newPos=4,i.x=newPos),"K"==i.pieceType&&5==i.x&&(newPos=e?7:3,i.x=newPos)}}function baseConverter(e,s,t){e+="",e=e.toUpperCase();for(var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",a=0,r=0;r<=e.length;r++)a+=i.indexOf(e.charAt(r))*Math.pow(s,e.length-r-1);e="";for(var o=Math.floor(Math.log(a)/Math.log(t)),r=o;r>=0;r--){var n=Math.floor(a/Math.pow(t,r));e+=i.charAt(n),a-=n*Math.pow(t,r)}return 0==e.length&&(e=0),e}function resetNotation(){var e=myChess.chessObj.notations;for(i=0;i<e.length;i++)e[i].w&&(e[i].w.backgroundColor="white"),e[i].b&&(e[i].b.backgroundColor="white")}function setNotation(e){resetNotation();var s=myChess.chessObj.notation,t=myChess.chessObj.notations;if(e>0){var i=Math.floor((e-1)/2),a=(e-1)%2;0==a?t[i].w.backgroundColor="orange":t[i].b.backgroundColor="orange";var r=0,o=t.length-1;i>4&&(r=i-5),o>i+5&&(o=i+5),s.fireEvent("show",{index:r}),s.fireEvent("show",{index:o})}}function putPieces(e){if(myChess.chessObj.currentMove=e,0>e&&(e=0),myChess.chessObj.piecesStatus[e]){setNotation(e);for(var s=0;2>s;s++)for(var t=0;16>t;t++){var i=myChess.chessObj.piecesStatus[e][s][t].obj;if(0!=myChess.chessObj.piecesStatus[e][s][t].onboard){var a=myChess.chessObj.piecesStatus[e][s][t].x,r=myChess.chessObj.piecesStatus[e][s][t].y,o=myChess.chessObj.grids[r][a-1];i.left=o.pleft,i.top=o.ptop}else i.left=-200,i.top=-200}}}function movePieces(e){myChess.chessObj.currentMove=e,e-1>myChess.chessObj.currentMove&&putPieces(e-1),moveAPiece(e)}function highlightGrid(e,s){e&&(s?(e.width-=e.size1,e.height-=e.size1,e.left=e.left1,e.top=e.top1):(e.width=e.size2,e.height=e.size2,e.left=e.left2,e.top=e.top2))}function focusMoves(e){highlightGrid(myChess.chessObj.focus[0],e),highlightGrid(myChess.chessObj.focus[1],e),e||(myChess.chessObj.focus[0]=null,myChess.chessObj.focus[1]=null)}myChess.f.resetPieces=function(){putPieces(newMove)},myChess.f.moveBackward=function(){var e=myChess.chessObj.moves;e&&(newMove=myChess.chessObj.currentMove/1-1,0>newMove&&(newMove=0),putPieces(newMove))},myChess.f.moveForward=function(){var e=myChess.chessObj.moves;if(e){var s=2*e.length-(1==e[e.length-1].length?1:0);newMove=myChess.chessObj.currentMove/1+1,newMove>s||movePieces(newMove)}},myChess.f.play=function(){myChess.chessObj.playModeInProgress||(myChess.chessObj.playModeInProgress=!0,processPlay())},myChess.f.pause=function(){myChess.chessObj.playModeInProgress=!1},myChess.f.getPiecesStatus=function(){var e=myChess.chessObj.moves,s=myChess.chessObj.maxMoves+1;for(myChess.chessObj.piecesStatus=new Array(s),i=0;s>i;i++)myChess.chessObj.piecesStatus[i]=new Array(3),myChess.chessObj.piecesStatus[i][0]=new Array(16),myChess.chessObj.piecesStatus[i][1]=new Array(16),myChess.chessObj.piecesStatus[i][2]=null;resetBoard();var t=0,a="["+myChess.chessObj.piecesStatus[t][2]+"]";for(type=0;2>type;type++)for(p=0;16>p;p++)myChess.chessObj.piecesStatus[t][type][p]=new Array,myChess.chessObj.piecesStatus[t][type][p].x=myChess.chessObj.boardPieces[type][p].obj.file,myChess.chessObj.piecesStatus[t][type][p].y=myChess.chessObj.boardPieces[type][p].obj.rank,myChess.chessObj.piecesStatus[t][type][p].obj=myChess.chessObj.boardPieces[type][p].obj,myChess.chessObj.piecesStatus[t][type][p].onboard=!0,a+=" ("+myChess.chessObj.piecesStatus[t][type][p].obj.pieceType+"  "+myChess.chessObj.piecesStatus[t][type][p].x+","+myChess.chessObj.piecesStatus[t][type][p].y+") ";for(var t=1;s>t;t++){var r=Math.floor((t-1)/2),o=(t-1)%2;if(e[r][o]){var n=translateAMove(e[r][o],o),h=100*o+n;for(myChess.chessObj.piecesStatus[t][2]=h,a="["+myChess.chessObj.piecesStatus[t][2]+"]",type=0;2>type;type++)for(p=0;16>p;p++)myChess.chessObj.piecesStatus[t][type][p]=new Array,myChess.chessObj.piecesStatus[t][type][p].obj=myChess.chessObj.boardPieces[type][p].obj,myChess.chessObj.piecesStatus[t][type][p].x=myChess.chessObj.boardPieces[type][p].x,myChess.chessObj.piecesStatus[t][type][p].y=myChess.chessObj.boardPieces[type][p].y,myChess.chessObj.piecesStatus[t][type][p].onboard=myChess.chessObj.boardPieces[type][p].onboard,a+=" ("+myChess.chessObj.piecesStatus[t][type][p].obj.pieceType+"  "+myChess.chessObj.piecesStatus[t][type][p].x+","+myChess.chessObj.piecesStatus[t][type][p].y+") "}}};